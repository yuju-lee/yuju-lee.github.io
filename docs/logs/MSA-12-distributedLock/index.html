<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <title>MSA-12. ë¶„ì‚°ë½ ì „í™˜ê¸°</title>
    <meta name="description"
        content="ê¸°íší–ˆë˜ ëŒ€ë¡œ ìš°ì„  êµ¬í˜„í•´ ë³´ì•˜ë‹¤.">
    <link rel="canonical" href="https://yuju-lee.github.io/logs/MSA-12-distributedLock/">
    

    <!-- Site Favicon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/png" />

    <!-- CSS Styles -->
    <link href="/assets/css/style.css" rel="stylesheet">
</head>



<body class="layout-post">
    <div id="page" class="site">
        <header class="site-header">
    <div class="inner">
        <div class="site-branding">
            
                <h1 class="site-title"><a href="/" rel="home">Judy's Devlog</a></h1>
                <p class="site-description">Cool developers never dies</p>
            
        </div><!-- .site-branding -->
        <button id="show-sidebar" class="toggle-sidebar">
            <span class="screen-reader-text">Discover More</span>
            <span aria-hidden="true" class="icon-plus"></span>
        </button>
    </div><!-- .inner -->
    <!-- Highlight.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/atom-one-dark.min.css">
    <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/png" />
</header><!-- .site-header -->
        <div id="content" class="site-content">
    <main id="main" class="site-main inner">
        <article class="post">
            
            <header class="entry-header">
                <h1 class="entry-title">MSA-12. ë¶„ì‚°ë½ ì „í™˜ê¸°</h1>
                <div class="entry-meta">
                    
                    
                    <span class="post-author"><a href="https://yuju-lee.github.io/author/judy">judy</a></span>
                    
                    
                    <span class="post-categories">
                        
                        <a href="https://yuju-lee.github.io/categories/logs">logs</a>
                        
                    </span>
                    <span class="post-date">
                        <time class="published" datetime="2024-07-03">July 3, 2024</time>
                    </span>
                </div><!-- .entry-meta -->
            </header><!-- .entry-header -->
            <div class="entry-content">
                <p>ê¸°íší–ˆë˜ ëŒ€ë¡œ ìš°ì„  êµ¬í˜„í•´ ë³´ì•˜ë‹¤.</p>

<h3 id="ê²°ì œ-ì§„ì…-ë¡œì§">ê²°ì œ ì§„ì… ë¡œì§</h3>

<p>í´ë¼ì´ì–¸íŠ¸ëŠ” ê²°ì œ ìš”ì²­ì„ í•˜ë©´ ëŒ€ê¸°ì—´ì— ì§„ì…í•œë‹¤. (Client â†’ PaymentController â†’ PaymentQueueService â†’ PaymentService)</p>

<ul>
  <li><strong>PaymentController</strong>: ê²°ì œ ìš”ì²­ì„ ìˆ˜ì‹ </li>
  <li><strong>PaymentQueueService:</strong> ê²°ì œ ìš”ì²­ì„ ëŒ€ê¸°ì—´ì— ì¶”ê°€í•˜ê³  ëŒ€ê¸°ì—´ì—ì„œ ìš”ì²­ì„ ê°€ì ¸ì˜´</li>
  <li><strong>PaymentService:</strong> ì£¼ê¸°ì ìœ¼ë¡œ ëŒ€ê¸°ì—´ì„ í™•ì¸í•˜ì—¬ ê²°ì œ ìš”ì²­ ì²˜ë¦¬ (1ì´ˆë¡œ ì¼ë‹¨ ì¡ìŒ)</li>
</ul>

<p>í´ë¼ì´ì–¸íŠ¸ëŠ” ê²°ì œ ìš”ì²­ì„ í•  ë•Œ {ì œí’ˆëª…, êµ¬ë§¤ìˆ˜ëŸ‰} í˜•ì‹ìœ¼ë¡œ PaymentServiceì— ìš”ì²­í•œë‹¤.</p>

<p>í´ë¼ì´ì–¸íŠ¸ì˜ ê²°ì œ ìš”ì²­ì„ PaymentQueueServiceê°€ ë°›ìœ¼ë©´, <strong>ì‹¤ì‹œê°„ ì¬ê³ í™•ì¸ì„ ìš°ì„ ì ìœ¼ë¡œ ì§„í–‰</strong></p>

<ol>
  <li>ì¬ê³ ê°€ ë‚¨ì•„ìˆëŠ” ê²½ìš° ê°€ìƒ ëŒ€ê¸°ì—´ì— ì¶”ê°€</li>
  <li>ì¬ê³ ê°€ ì—†ëŠ” ê²½ìš° ëŒ€ê¸°ì—´ ì¶”ê°€ ê±°ë¶€ â†’ í’ˆì ˆ ë©”ì‹œì§€ ì‘ë‹µ</li>
</ol>

<p>PaymentServiceëŠ” ëŒ€ê¸°ì—´ì˜ ìš”ì²­ì„ ê²°ì œ ìš”ì²­ ë¡œì§ì„ ê²°ì œ ì„œë¹„ìŠ¤ë¡œ ë³´ë‚¸ë‹¤. (ê²°ì œ ì‹œë„ ì‹¤íŒ¨ 20% / ê²°ì œ ì¤‘ ì‹¤íŒ¨ 20%)
ê²°ì œëŠ” ì‹¤ì œ ê²°ì œê°€ ì´ë£¨ì–´ì§€ì§€ ì•Šê¸° ë•Œë¬¸ì— ê²°ì œê°€ ì„±ê³µí•˜ë©´ ê²°ì œ ë©”ì‹œì§€ì™€ í•¨ê»˜ í•´ë‹¹ ì •ë³´ë¥¼ order ì„œë¹„ìŠ¤ë¡œ ë³´ë‚´ê³ , ê²°ì œê°€ ì‹¤íŒ¨í•˜ë©´ ë ˆë””ìŠ¤ì—ì„œ ì¬ê³ ë¥¼ ë°”ë¡œ ë³µêµ¬í•œë‹¤.</p>

<p>ì—¬ê¸°ê¹Œì§€ëŠ” êµ¬í˜„í•˜ì˜€ìœ¼ë‚˜, ë¶„ì‚°ë½ìœ¼ë¡œë„ êµ¬í˜„ì´ ê°€ëŠ¥í•˜ë‹¤ê³  í•œë‹¤. ë”°ë¼ì„œ ë¶„ì‚°ë½ ì™„ì„± â†’ í…ŒìŠ¤íŠ¸íˆ´ êµ¬ì¶• â†’ ë¶„ì‚°ë½ í…ŒìŠ¤íŠ¸í•˜ê³  ì´ì „ ê°€ìƒ ëŒ€ê¸°ì—´ë¡œ ë¡¤ë°±í•´ì„œ ê°™ì€ í…ŒìŠ¤íŠ¸íˆ´ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ í•´ ë³¼ ì˜ˆì •ì´ë‹¤.</p>

<h3 id="ë¶„ì‚°ë½ì´ë€-">ë¶„ì‚°ë½ì´ë€? ğŸ”</h3>

<p>ë¶„ì‚° ë½ì€ ì—¬ëŸ¬ í´ë¼ì´ì–¸íŠ¸ê°€ ë™ì‹œì— íŠ¹ì • ìì›ì— ì ‘ê·¼í•˜ì§€ ëª»í•˜ë„ë¡ í•˜ëŠ” ë½ ë©”ì»¤ë‹ˆì¦˜ì´ë‹¤. ì´ëŠ” ì£¼ë¡œ Redisì™€ ê°™ì€ ì¸ë©”ëª¨ë¦¬ ë°ì´í„° ì €ì¥ì†Œë¥¼ í†µí•´ êµ¬í˜„ë˜ë©°, ê³ ì†ì˜ ë½/ì–¸ë½ ì—°ì‚°ì´ ê°€ëŠ¥í•˜ì—¬ ë¶„ì‚° í™˜ê²½ì—ì„œ íš¨ìœ¨ì ì¸ ìì› ê´€ë¦¬ë¥¼ í•  ìˆ˜ ìˆëŠ” ê²ƒì´ ì¥ì ì´ë‹¤.</p>

<h3 id="redisë¥¼-ì‚¬ìš©í•œ-ë¶„ì‚°-ë½ì˜-ì‘ë™-ë°©ì‹">Redisë¥¼ ì‚¬ìš©í•œ ë¶„ì‚° ë½ì˜ ì‘ë™ ë°©ì‹</h3>

<ol>
  <li><strong>ë½ íšë“ (Lock Acquisition)</strong>
    <ul>
      <li>í´ë¼ì´ì–¸íŠ¸ëŠ” íŠ¹ì • í‚¤ì— ëŒ€í•´ SETNX (Set if Not Exists) ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ë½ì„ ì‹œë„</li>
      <li>ë½ í‚¤ì— ëŒ€í•œ ê°’ì„ â€œlockedâ€ë¡œ ì„¤ì •í•˜ê³ , ìœ íš¨ ì‹œê°„(TTL)ì„ ì„¤ì •í•˜ì—¬ ìë™ìœ¼ë¡œ ë½ í•´ì œ</li>
    </ul>
  </li>
  <li><strong>ë½ í•´ì œ (Lock Release)</strong>
    <ul>
      <li>í´ë¼ì´ì–¸íŠ¸ëŠ” ì‘ì—…ì´ ì™„ë£Œëœ í›„ ë½ í•´ì œ â†’ DEL ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ë½ í‚¤ ì‚­ì œ
        <ul>
          <li>ë½ í•´ì œ ì‹œ í‚¤ê°€ ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸ì— ì˜í•´ ë³€ê²½ë˜ì§€ ì•Šì•˜ìŒì„ ë³´ì¥í•˜ê¸° ìœ„í•´ ì›ìì  ì²´í¬ì™€ ì‚­ì œ ì‚¬ìš©</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>ë½ ìœ íš¨ ì‹œê°„ (Lock Expiry)</strong>
    <ul>
      <li>ë½ì„ ì„¤ì •í•  ë•Œ ìœ íš¨ ì‹œê°„ì„ ì„¤ì •í•˜ì—¬ íŠ¹ì • ì‹œê°„ì´ ì§€ë‚˜ë©´ ìë™ìœ¼ë¡œ ë½ì´ í•´ì œ
        <ul>
          <li>ì´ëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ë¹„ì •ìƒì ìœ¼ë¡œ ì¢…ë£Œë˜ì–´ ë½ì„ í•´ì œí•˜ì§€ ëª»í•  ê²½ìš°ì—ë„ ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸ê°€ ë½ì„ íšë“í•  ìˆ˜ ìˆë„ë¡ ë³´ì¥í•  ìˆ˜ ìˆìŒ</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<pre><code class="language-Java">public String processPayment(String email, int productId, int amount) throws JsonProcessingException {
    // ì œí’ˆ ì¬ê³ ë¥¼ ìœ„í•œ Redis í‚¤
    String redisKey = redisStockKeyPrefix + productId;

    // ë¶„ì‚° ë½ì„ 10ì´ˆ ë™ì•ˆ íšë“ ì‹œë„
    Boolean acquired = redisTemplate.opsForValue().setIfAbsent(redisKey + ":lock", "locked", 10, TimeUnit.SECONDS);
    if (acquired != null &amp;&amp; acquired) {
        try {
            // Redisì—ì„œ í˜„ì¬ ì¬ê³  ê°’ì„ ê°€ì ¸ì˜´
            String stockValueStr = redisTemplate.opsForValue().get(redisKey);

            if (stockValueStr != null) {
                Integer stock = Integer.valueOf(stockValueStr);

                // ì¬ê³  í™•ì¸
                if (stock &gt;= amount) {
                    // ê²°ì œ ì‹¤íŒ¨ í™•ë¥  20%
                    boolean paymentSuccess = random.nextDouble() &gt;= 0.2;

                    if (paymentSuccess) {
                        // ê²°ì œ ì„±ê³µ ì‹œ ì¬ê³  ì°¨ê°
                        redisTemplate.opsForValue().decrement(redisKey, amount);

                        // Kafka ì´ë²¤íŠ¸ ë°œí–‰
                        Map&lt;String, Object&gt; orderData = new HashMap&lt;&gt;();
                        orderData.put("email", email);
                        orderData.put("productId", productId);
                        orderData.put("amount", amount);
                        orderData.put("status", "COMPLETED");
                        kafkaTemplate.send("order-topic", objectMapper.writeValueAsString(orderData));
                        System.out.println("order sent");

                        // Kafka ì¬ê³  ì°¨ê° ì´ë²¤íŠ¸ ë°œí–‰
                        Map&lt;String, Object&gt; stockUpdateData = new HashMap&lt;&gt;();
                        stockUpdateData.put("productId", productId);
                        stockUpdateData.put("stock", redisTemplate.opsForValue().get(redisKey));
                        kafkaTemplate.send(stockUpdateTopic, objectMapper.writeValueAsString(stockUpdateData));

                        System.out.println("Payment succeeded for " + email + " for product " + productId);
                            return "Payment succeeded for " + email + " for product " + productId;
                        } else {
                            System.out.println("Payment failed for " + email + " for product " + productId);
                            return "Payment failed for " + email + " for product " + productId;
                        }
                    } else {
                    System.out.println("ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. í˜„ì¬ ì¬ê³ : " + stock);
                    return "ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. í˜„ì¬ ì¬ê³ : " + stock;
                }
            } else {
                System.out.println("ì¬ê³  ì •ë³´ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Redis í‚¤: " + redisKey);
                return "ì¬ê³  ì •ë³´ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Redis í‚¤: " + redisKey;
            }
        } finally {
            // ë½ í•´ì œ
            redisTemplate.delete(redisKey + ":lock");
        }
    } else {
        System.out.println("ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
        return "ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
    }
}
</code></pre>

<p>ìœ„ì™€ ê°™ì€ ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•˜ì˜€ê³ , í…ŒìŠ¤íŠ¸ ì‹œ ê²°ì œê°€ ì™„ë£Œë˜ì—ˆë‹¤.</p>

            </div>
            <footer class="entry-footer">
                
                <p class="post-tags">
                     
                    <a href="https://yuju-lee.github.io/tag/kafka">Kafka</a>, 
                     
                    <a href="https://yuju-lee.github.io/tag/redis">Redis</a>, 
                     
                    <a href="https://yuju-lee.github.io/tag/transaction">Transaction</a>, 
                     
                    <a href="https://yuju-lee.github.io/tag/distributed-lock">Distributed-Lock</a>, 
                     
                    <a href="https://yuju-lee.github.io/tag/java-springboot">JAVA-Springboot</a>
                    
                </p>
                
            </footer>
            
            
            <div class="author-box">
                <div class="author-info">
                    
                    <div class="avatar-container">
                        <img class="author-profile-image" src="https://yuju-lee.github.io/assets/images/judy.jpg" alt="judy" class="avatar" />
                    </div>
                    
                    <div class="author-details">
                        <h2 class="author-title">About <a href="https://yuju-lee.github.io/author/judy">judy</a></h2>
                        
                        <p class="author-description">junior BE</p>
                        
                        <div class="author-links">
                            
                            <a href="https://www.linkedin.com/in/yuju-lee" target="_blank" rel="noopener">
                                <i class="fa-globe" aria-hidden="true"></i>
                                <span class="screen-reader-text">Website</span>
                            </a>
                            
                            
                            
                        </div>
                    </div>
                </div><!-- .author-info -->
            </div><!-- .author-box -->
            
            
        </article>
        
            <div class="subscribe-box">
</div><!-- .widget -->
        
        <nav class="navigation post-navigation">
            <h2 class="screen-reader-text">Post navigation</h2>
            <div class="nav-links">
            
            <div class="nav-previous">
                <a href="https://yuju-lee.github.io/logs/MSA-11-payment/" class="nav-inside">
                    <span class="nav-before">Previous post</span>
                    <span class="nav-title">MSA-11. ëŒ€ìš©ëŸ‰ íŠ¸ë˜í”½ ì²˜ë¦¬ ë°©ë²•ì— ëŒ€í•œ í”„ë¡œì íŠ¸ ê¸°íš</span>
                    <span class="nav-meta">July 3, 2024</span>
                    
                    
                </a>
            </div>
            
            
            <div class="nav-next">
                <a href="https://yuju-lee.github.io/logs/MSA-13-integrityGuaranteed/" class="nav-inside">
                    <span class="nav-before">Next post</span>
                    <span class="nav-title">MSA-13. ì¬ê³  ë°ì´í„°ì˜ ë¬´ê²°ì„± ë³´ì¥</span>
                    <span class="nav-meta">July 3, 2024</span>
                    
                    
                </a>
            </div>
            
            </div><!-- .nav-links -->
        </nav><!-- .post-navigation -->
        
<div class="comments-area">
    <div class="comments-inside">
        <h2 class="comments-title">Comments</h2>
        <div id="disqus_thread"></div>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
                Disqus</a>.</noscript>
    </div><!-- .comments-inside -->
</div><!-- .comments-area -->
    <script type="text/javascript">
        var disqus_shortname = 'devlog-qiqv3mtjda';
        var disqus_developer = 0;
        (function () {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


    </main><!-- .site-main -->
</div><!-- .site-content -->

        

        <aside id="sidebar" class="sidebar">
	<div class="sidebar-inside">
		<button id="hide-sidebar" class="toggle-sidebar"><span class="screen-reader-text">Close</span><span aria-hidden="true"
			 class="icon-plus"></span></button>
			<nav id="sidebar-navigation" class="widget site-navigation">
				<h2 class="widget-title">Category</h2>
				<ul class="menu">
					
						<li class="menu-item"><a href="/about/">About</a></li>
					
						<li class="menu-item"><a href="/categories/algorithm/">Algorithm</a></li>
					
						<li class="menu-item"><a href="/categories/springboot/">Springboot</a></li>
					
						<li class="menu-item"><a href="/categories/logs/">Logs</a></li>
					
				</ul>
			</nav>
			<!-- Create a sorted array of tags -->
 
<section class="widget widget-tagcloud">
    <h2 class="widget-title">Tags</h2>
    <div class="tagcloud">
        
        <a href='/tag/api-gateway/'>API-Gateway</a>
        
        <a href='/tag/auth/'>Auth</a>
        
        <a href='/tag/distributed-lock/'>Distributed-Lock</a>
        
        <a href='/tag/distributed-lock/'>Distributed-lock</a>
        
        <a href='/tag/docker/'>Docker</a>
        
        <a href='/tag/erd/'>ERD</a>
        
        <a href='/tag/encryption/'>Encryption</a>
        
        <a href='/tag/feign-client/'>Feign-Client</a>
        
        <a href='/tag/java-springboot/'>JAVA-Springboot</a>
        
        <a href='/tag/jwt/'>JWT</a>
        
        <a href='/tag/kafka/'>Kafka</a>
        
        <a href='/tag/luascript/'>LuaScript</a>
        
        <a href='/tag/msa/'>MSA</a>
        
        <a href='/tag/redis/'>Redis</a>
        
        <a href='/tag/taskscheduler/'>TaskScheduler</a>
        
        <a href='/tag/test-tool/'>Test-tool</a>
        
        <a href='/tag/transaction/'>Transaction</a>
        
        <a href='/tag/googlesmtp/'>googleSMTP</a>
        
        <a href='/tag/java/'>java</a>
        
        <a href='/tag/mail-service/'>mail-service</a>
        
    </div>
</section>
	</div><!-- .sidebar-inside -->
</aside><!-- .sidebar -->
        <footer id="colophon" class="site-footer outer">
    <div class="inner">
        <div class="footer-bottom">
            <p class="social-links">
    
    
    
    <a href="https://github.com/yuju-lee" target="_blank">
        <span class="fa-github fa" aria-hidden="true"></span>
        <span class="screen-reader-text">GitHub</span>
    </a>
    
    
    
    
    
    
    
    <a href="https://www.linkedin.com/in/yuju-lee" target="_blank">
        <span class="fa-linkedin fa" aria-hidden="true"></span>
        <span class="screen-reader-text">Linkedin</span>
    </a>
    
</p>
            <p class="site-info">
                <a href="#">Judy's Devlog</a> &copy; 2024 
            </p>
            <a href="#page" id="top-link" class="top-link"><i class="fa-arrow-left-custom" aria-hidden="true"></i> <span class="top-link-text">Up</span></a>
        </div><!-- .footer-bottom -->
    </div><!-- .inner -->
</footer><!-- .site-footer -->

    </div><!-- .site -->
    <div id="site-overlay" class="site-overlay"></div>

    
  <script async src="https://www.googletagmanager.com/gtag/js?id="></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', '', { 'anonymize_ip': true });
  </script>

    <!-- Javascript Assets -->
    <script src="/assets/js/jquery-3.4.1.min.js"></script>
    <script src="/assets/js/plugins.js"></script>
    <script src="/assets/js/custom.js"></script>
    <!-- Highlight.js JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
</body>

</html>